//Handling exceptions from base class or member destructors(note:exceptions should never get out of a destructor),
//but if it does then
//it should be either handled by 
//the derived class object
//or the class object that it is a member of.

#include <iostream>
#include <stdexcept>
#include <string>

// --- Custom Exception Class ---
class CleanupFailure : public std::runtime_error {
public:
    CleanupFailure(const std::string& msg)
        : std::runtime_error("Cleanup Failed: " + msg) {}
};

// --- Base Class  ---
class BaseResource {
public:
    BaseResource() {
        std::cout << "BaseResource constructed.\n";
    }

    virtual ~BaseResource() noexcept(false) { 
        std::cout << "  [Base Destructor] Attempting resource cleanup...\n";
        bool critical_failure = true;
        if (critical_failure) {
            std::cout << "  [Base Destructor] Throwing CleanupFailure!\n";
            throw CleanupFailure("Failed to release external lock."); 
        }
        std::cout << "  [Base Destructor] Clean up successful.\n";
    }
};

// --- Derived Class ( Handles the Base Destructor's Exception) ---
class DerivedWorker : public BaseResource {
public:
    DerivedWorker() {
        std::cout << "DerivedWorker constructed.\n";
    }

    
    ~DerivedWorker() override 
    try 
    {
        
        std::cout << "  [Derived Destructor] Starting cleanup.\n";
        
        // When this body finishes, the implicit call to ~BaseResource() happens next.

    } 
    catch (const CleanupFailure& e) // <--- 'catch' is placed after the body closure
    {
        // --- DERIVED DESTRUCTOR HANDLES ---
        std::cerr << "!!! DERIVED DESTRUCTOR CAUGHT EXCEPTION !!!\n";
        std::cerr << "Error: " << e.what() << "\n";
        
        
        // Since we dont throw a
        //new EXCEPTION
        //this should rethrow
        //as is the case with all catch clauses in constructors and destructors
    }
};

int main() {
    std::cout << "--- Main Program Start ---\n";
    
    try {
        DerivedWorker* worker = new DerivedWorker();
        std::cout << "\nManually deleting worker object...\n";
        delete worker;
        
    } catch (const CleanupFailure& e) {
        // This should be reached because 
        //catch clauses in constructors and destructors
        //rethrow by default if you dont throw a new exception urself
        std::cerr << "\nthe main catch clause reached as expected\n";
        std::cerr << "Final Exception: " << e.what() << "\n";
    }
    
    std::cout << "\n--- Main Program End (Successfully continued) ---\n";
    return 0;
}

// --- Derived Class (CORRECTLY Handles the Base Destructor's Exception) ---
class DerivedWorker : public BaseResource {
public:
    DerivedWorker() {
        std::cout << "DerivedWorker constructed.\n";
    }

    // *** CORRECT SYNTAX: FUNCTION-TRY-BLOCK ***
    ~DerivedWorker() override 
    try // <--- 'try' keyword is placed here
    {
        // This is the derived destructor's body (all code here is monitored)
        std::cout << "  [Derived Destructor] Starting cleanup.\n";
        
        // When this body finishes, the implicit call to ~BaseResource() happens next.

    } 
    catch (const CleanupFailure& e) // <--- 'catch' is placed after the body closure
    {
        // --- DERIVED DESTRUCTOR HANDLES ---
        std::cerr << "!!! DERIVED DESTRUCTOR CAUGHT EXCEPTION !!!\n";
        std::cerr << "Error: " << e.what() << "\n";
        std::cerr << "Local action: Logging error and suppressing rethrow.\n";
        
        // Since we omit 'throw;', the exception is suppressed, and the main
        // program continues execution normally.
    }
};

int main() {
    std::cout << "--- Main Program Start ---\n";
    
    try {
        DerivedWorker* worker = new DerivedWorker();
        std::cout << "\nManually deleting worker object...\n";
        delete worker;
        
    } catch (const CleanupFailure& e) {
        // This should NOT be reached, as the derived destructor handled it.
        std::cerr << "\n!!! ERROR: This catch block was reached (Suppression Failed)! !!!\n";
        std::cerr << "Final Exception: " << e.what() << "\n";
    }
    
    std::cout << "\n--- Main Program End (Successfully continued) ---\n";
    return 0;
}
